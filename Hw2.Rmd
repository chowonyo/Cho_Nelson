---
title: "Nelson Lab Hw 2"
author: "Paul Cho"
date: "2025-09-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1.	Use the ‘setup.Rmd’ file to create the folders that you will use for the analysis of this dataset.

### Loading packages first
Run install.packages ("here") in the console
```{r}
library(Seurat)
library(dplyr)
library(here)
here()
```
### 1.1 Music selection
[Pat Metheny Group - Pat Metheny Group](https://open.spotify.com/album/4TC69U5HGclykFldzvsIao?si=WRLgAvpWSEO2S4D1JIc_lQ)

### Making folders
<p> Using concatenate to make a list of folder names, then storing it in object "dirs"(directories). Folder names & functionalities were recommended by chat </p>
```{r}
# - data/cellranger: where barcodes.tsv.gz, features.tsv.gz, matrix.mtx.gz (Q2) will go
# - outputs: where you'll later save the Seurat object .rds (Q3f)
# - results/figures, results/tables: plots and tabular outputs
# - qc, logs, docs, scripts: supporting work
dirs <- c(
  "data/raw",
  "data/cellranger",   # for barcodes.tsv.gz, features.tsv.gz, matrix.mtx.gz
  "data/processed",
  "scripts",
  "results/figures",
  "results/tables",
  "outputs",           # folder to save .rds files
  "qc",
  "logs",
  "docs"
)
```
## 1a.	Knit the file and add documentation that you created the folders.

Creating folders
```{r}
full_paths <- file.path(here(), dirs)
created <- logical(length(full_paths))

for (i in seq_along(full_paths)) {
  if (!dir.exists(full_paths[i])) {
    dir.create(full_paths[i], recursive = TRUE, showWarnings = FALSE)
    created[i] <- TRUE
  } else {
    created[i] <- FALSE
  }
}
```

Making sure the code prints as a log
```{r}
creation_log <- data.frame(
  directory = dirs,
  path      = full_paths,
  status    = ifelse(created, "created", "already existed"),
  row.names = NULL
)
creation_log
```
I'm assuming the "already existed" part is because I already ran the script?

***

# 2.	Move the Cell Ranger Output files (barcodes.tsv.gz, features.tsv.gz, matrix.mtx.gz) into the new folder.

Not sure whether I'm being asked to move them into cellranger with code? or just dragging & dropping them .. chat helped make template for this chunk:
```{r}
source_dir <- "~/Desktop/R projects/Nelson Hw 2/Homework Dataset"
destination_dir <- here::here("data", "cellranger")

files_to_move <- c("barcodes.tsv.gz", "features.tsv.gz", "matrix.mtx.gz")

# Loop and move
for (f in files_to_move) {
  file.copy(from = file.path(source_dir, f),
            to   = file.path(destination_dir, f),
            overwrite = TRUE)
}

```

## 2a. Use the package here() to upload the dataset so it sets a relative file length to upload the file.
### Building path to cellranger folder
```{r}
data_dir <- here("data", "cellranger")

list.files(data_dir)

kidney.data <- Read10X(data.dir = data_dir)
```

Wrap into a Seurat object
```{r}
kidney <- CreateSeuratObject(counts = kidney.data, project = "Kidney")
kidney
```

***

# 3)	Analyze the shotgun kidney snRNAseq dataset. 
Quality control using seurat
```{r}
cells_before <- ncol(kidney)
kidney[["percent.mt"]] <- PercentageFeatureSet(kidney, pattern = "^mt-")
head(kidney@meta.data)
VlnPlot(kidney, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
kidney <- subset(kidney, subset = nFeature_RNA < 2000 & nFeature_RNA < 4000 & percent.mt < 20)
cells_after <-ncol(kidney)
cells_removed <- cells_before - cells_after
VlnPlot(kidney, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
kidney <- NormalizeData(kidney, normalization.method = "LogNormalize", scale.factor = 10000)
kidney <- FindVariableFeatures(kidney, selection.method = "vst", nfeatures = 2000)
```
cells_before and cells_after were created for 3ii

### i.	What filtering parameters did you choose? Why? 
1. Filtering out samples with a high % of mitochondrial genes i.e. dying/damaged cells
2. Filtering out empty droplets & doublets, code from last week's answers

### ii.	How many cells do they filter out?

Using concatenate to print the number of cells filtered out:
```{r}
c(cells_before = cells_before,
  cells_after  = cells_after,
  cells_removed = cells_removed)
```

## b.	What resolution did decide to do use to maximize clustering diversity?
Clustering(reusing code from last week):
```{r}
all.genes <- rownames(kidney)
kidney <- ScaleData(kidney, features = all.genes)
kidney <- RunPCA(kidney, features = VariableFeatures(object = kidney))
kidney <- FindNeighbors(kidney, dims = 1:10)
kidney <- FindClusters(kidney, resolution = 0.15)
print(kidney[["pca"]], dims = 1:5, nfeatures = 5)
```

Getting UMAP
```{r}
kidney <- RunUMAP(kidney, dims = 1:20)
DimPlot(kidney, reduction = "umap", label = TRUE)
```

i.	How many clusters did you get?
13 clusters(0-12)
ii.	Name the clusters at two different levels of specificity
Confused by the wording of the question but I'm assuming I should use [Balzer et al.](https://pmc.ncbi.nlm.nih.gov/articles/PMC9233501/#:~:text=The%20kidney%20maintains%20electrolyte%2C%20water,types%20in%20the%20mammalian%20kidney.) to identify different cell types?

```{r}
kidney.markers <- FindAllMarkers(kidney, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
kidney.markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC)

top5 <- kidney.markers %>%
  group_by(cluster) %>%
  slice_max(order_by = avg_log2FC, n = 5) %>%
  arrange(cluster, desc(avg_log2FC))
```
I used chat to categorize my data based on Balzer et al., probably not the best idea?? What's a way I can do this manually?
```{r}
annot_tbl <- data.frame(
  Cluster = 0:12,
  Broad = c(
    "Proximal tubule","Immune (mixed)","TAL","Collecting duct",
    "DCT","Proximal tubule","Proximal tubule","Podocyte",
    "CNT / late DCT","Collecting duct (IC)","Endothelial",
    "Stromal","Macrophage/monocyte"
  ),
  Fine = c(
    "PT S1/S2","T/B/NK mix","TAL (thick ascending limb)","CD principal",
    "DCT","PT S3","Injured/oxidative PT","Podocyte",
    "Connecting tubule","Intercalated (IC-A/B)","Capillary/glomerular/lymphatic endothelium",
    "Fibroblast / mesangial / VSMC-pericyte","Macrophage/monocyte"
  ),
  Evidence = c(
    "Slc5a2, Slc5a12, Lrp2, Slc34a1, Aqp1",
    "Cd3d/Cd3e; Ms4a1/Cd79a; Nkg7/Gzmb",
    "Umod, Slc12a1, Kcnj1, Cldn10",
    "Aqp2, Aqp3, Scnn1g, Avpr2",
    "Slc12a3, Trpm6, Pvalb",
    "Slc22a6, Slc22a8, Gstm1, Cyp2d26",
    "Havcr1 (Kim1), Cyp*",
    "Nphs1, Nphs2, Synpo, Wt1",
    "Calb1, Trpv5, Scnn1b, Kcnj10",
    "Atp6v1b1/Slc4a1 (IC-A), Slc26a4 (IC-B)",
    "Pecam1, Kdr, Cldn5 / Emcn / Lyve1, Prox1, Pdpn",
    "Col1a1, Dcn, Lum / Pdgfrb, Itga8 / Acta2, Myh11, Rgs5",
    "Lyz2, Adgre1, C1qa/C1qb, Cd68"
  ),
  stringsAsFactors = FALSE
)

knitr::kable(annot_tbl, caption = "Cluster annotations (broad & fine) with marker evidence")

```
iii.	Provide evidence for why you are naming the clusters as such.
Marker expressions consistent with Balzer et al. as seen above (?)

## c.	Re-level the clusters in a biological order that makes sense.
i.	How did you decide on the order?
Biological order: through nephron flow(e.g. podocyte -> proximal tubule -> loop of henle -> collecting duct?? Not sure how to put this into code though (Will try again after getting some advice)

## d.	Identify and print the DEGs that define one of the cell types in your dataset
Identifying DEGs with FindMarkers, getting the top enriched genes then printing the top 20 markers - not sure how to do this part

## e.	Create a multidimensional dotplot that helped you determine the cell identity. i.	Order the genes/cells to make a diagonal.
??? No idea where to start, will try again after getting advice

## f.	Save your object as a .rds file in the outputs folder.
Saving the processed Seurat object in the outputs folder
```{r}
saveRDS(kidney, file = here("outputs", "kidney_processed.rds"))
```
